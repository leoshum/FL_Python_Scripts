SET XACT_ABORT ON;

DECLARE @UpdateId NVARCHAR(100);
SET @UpdateId = N'Update220822_AddAllowCopyForwardDistrictSettings';

BEGIN TRANSACTION;

INSERT INTO iep.Version
(
    UpdateId
)
VALUES
    (@UpdateId);

DECLARE @Author NVARCHAR(50) = N'd.semyonova';
DECLARE @Date DATETIME2 = GETDATE();

IF NOT EXISTS
(
    SELECT 1
    FROM iep.DistrictSettingDefinition
    WHERE DistrictSettingDefinitionId = 'D4F817F5-8254-4764-83CE-9627032867D7'
)
    INSERT INTO iep.DistrictSettingDefinition
    (
        DistrictSettingDefinitionId,
        DistrictSettingKey,
        Name,
        DefaultValue,
        IsActive,
        ValueType,
        Type,
        CreatedBy,
        CreatedDate,
        UpdatedBy,
        UpdatedDate
    )
    VALUES
    (   'D4F817F5-8254-4764-83CE-9627032867D7',             -- DistrictSettingDefinitionId - uniqueidentifier
        N'AllowCopyForward',                                -- DistrictSettingKey - nvarchar(100)
        N'Enable users to copy forward text field content', -- Name - nvarchar(1000)
        NULL,                                               -- DefaultValue - nvarchar(1000)
        1,                                                  -- IsActive - bit
        4,                                                  -- ValueType - int
        0,                                                  -- Type - int
        @Author,                                            -- CreatedBy - nvarchar(50)
        @Date,                                              -- CreatedDate - datetime
        @Author,                                            -- UpdatedBy - nvarchar(50)
        @Date                                               -- UpdatedDate - datetime
        );

--AllowCopyForward
IF EXISTS
(
    SELECT 1
    FROM sys.columns
    WHERE name = N'AllowCopyForward'
          AND object_id = OBJECT_ID(N'iep.DistrictSettingProgramType')
)
BEGIN
EXEC ('
    INSERT INTO iep.DistrictSettingValue
    (
        DistrictSettingValueId,
        DistrictSettingDefinitionId,
        CommonDistrictId,
        Value,
        CreatedBy,
        CreatedDate,
        UpdatedBy,
        UpdatedDate,
        DistrictSettingCategoryId
    )
    SELECT NEWID(),                                  -- DistrictSettingValueId - uniqueidentifier
           ''D4F817F5-8254-4764-83CE-9627032867D7'', -- DistrictSettingDefinitionId - uniqueidentifier
           DS.CommonDistrictId,                      -- CommonDistrictId - int
           CASE
               WHEN DSPT.AllowCopyForward = 1 THEN
                   ''true''
               WHEN DSPT.AllowCopyForward = 0 THEN
                   ''false''
               ELSE
                   NULL
           END,                                    -- Value - nvarchar(1000)
           @Author,                                -- CreatedBy - nvarchar(50)
           @Date,                                  -- CreatedDate - datetime
           @Author,                                -- UpdatedBy - nvarchar(50)
           @Date,                                  -- UpdatedDate - datetime
           DSC.DistrictSettingCategoryId
    FROM iep.DistrictSetting DS
        JOIN iep.DistrictSettingProgramType DSPT
            ON DSPT.DistrictSettingId = DS.DistrictSettingId
        JOIN iep.DistrictSettingCategory DSC
            ON DSC.ProgramType = DSPT.ProgramType;
			');
END;

PRINT 'The database update succeeded.';
COMMIT TRANSACTION;